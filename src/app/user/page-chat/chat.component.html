<ng-template #NewGroup>
    <div>
        <h2 mat-dialog-title class="m-0">New Group</h2>
    </div>
    <mat-dialog-content class="py-0">
        <div style="width: 767px;">
            <input type="text" name="group-name" id="group-name-input" placeholder="Name of Group"
                class="form-control mb-2" [(ngModel)]="groupName">
            <h2>Group Members</h2>
            <div id="peoples-section-body">
                <div *ngFor="let userId of inGroupUsers.keys()" class="inGroupUsers">
                    <div (click)="addToGroup(userId)" class="user-tile">
                        <img [src]="userProfileImageMap.get(userId)" alt="User Profile">
                        <div class="ms-3">
                            <p> {{ '@'+inGroupUsers.get(userId)!.username }} </p>
                            <p> {{ inGroupUsers.get(userId)!.name }} </p>
                        </div>
                    </div>
                    <mat-icon fontIcon="close" *ngIf="userId !== currentUser.id"
                        (click)="removeFromGroup(userId)"></mat-icon>
                </div>
            </div>
            <h2>Add Members From</h2>
            <div id="peoples-section-body">
                <div *ngFor="let userId of notInGroupUsers.keys()">
                    <div (click)="addToGroup(userId)" class="user-tile">
                        <img [src]="userProfileImageMap.get(userId)" alt="User Profile">
                        <div class="ms-3">
                            <p> {{ '@'+notInGroupUsers.get(userId)!.username }} </p>
                            <p> {{ notInGroupUsers.get(userId)!.name }} </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </mat-dialog-content>
    <mat-dialog-actions>
        <button (click)="createNewGroup()" type="button" class="btn btn-success form-control m-1">Create</button>
        <button (click)="close()" type="button" class="btn btn-warning form-control m-1">Cancel</button>
    </mat-dialog-actions>
</ng-template>
<ng-template #NewChat>
    <div>
        <h2 mat-dialog-title class="m-0">New Chat</h2>
    </div>
    <mat-dialog-content class="py-0">
        <div>
            <div id="peoples-section-body">
                <div *ngFor="let user of allUsers">
                    <div (click)="chatWithUser(user); close()" class="user-tile">
                        <img [src]="userProfileImageMap.get(user.id!)" alt="User Profile">
                        <div class="ms-3">
                            <p> {{ user.username }} </p>
                            <Span>Online / Last Seen</Span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </mat-dialog-content>
    <mat-dialog-actions>
        <button (click)="close()" type="button" class="btn btn-dark form-control m-1">Cancel</button>
    </mat-dialog-actions>
</ng-template>

<article>
    <div id="side-nav"> 
        <side-nav-bar></side-nav-bar>
    </div>
<!-- PEOPLE LISTING SECTION STARTS HERE -->
    <div id="peoples-section">
        <!-- TOP SECTION -->
        <div id="peoples-section-header">
            <p> Chats </p>
            <input type="text" 
                    class="form-control rounded-5" 
                    id="search" 
                    name="search" 
                    placeholder="Search"
                    [(ngModel)]="searchText">
            <div id="peoples-section-footer" class="pt-3">
                <div (click)="showGroups = false" [class]="{'active': !showGroups}">
                    Personal
                </div>
                <div (click)="showGroups = true" [class]="{'active': showGroups}">
                    Groups
                </div>
            </div>
        </div>
        <!-- TOP SECTION ENDS -->
        <!-- LISTING SECTION -->
        <div id="peoples-section-body" class="peoples-scroll" *ngIf="showGroups">
            <div *ngFor="let group of groups">
                <div (click)="chatInGroup(group)" class="user-tile">
                    <img src="assets/no-profile-image.jpg" alt="User Profile">
                    <div class="ms-3">
                        <p> {{ group.groupName }} </p>
                        <Span>{{ group.membersId.length +' Members'}}</Span>
                    </div>
                </div>
            </div>
        </div>
        <div id="peoples-section-body" class="peoples-scroll" *ngIf="!showGroups">
            <div *ngFor="let user of friendsList">
                <div (click)="chatWithUser(user)" class="user-tile">
                    <img [src]="userProfileImageMap.get(user.id!)" alt="User Profile">
                    <div class="ms-3">
                        <p> {{ user.username }} </p>
                        <Span>Online / Last Seen</Span>
                    </div>
                </div>
            </div>
        </div>
        <!-- LISTING SECTION ENDS -->
         <!-- FOOTER -->
        <div id="peoples-section-footer">
            <div (click)="openNewChat()">New Chat</div>
            <div (click)="open()">New Group</div>
        </div>
        <!-- FOOTER -->
    </div>
<!-- PEOPLE LISTING SECTION ENDS HERE -->
<!-- CHAT SECTION -->
    <div id="chat-section" *ngIf="(receiver || group)">
        <!-- CHAT HEADER -->
        <div id="chat-header">
            <img class="user-profile-picture" 
                [src]="receiver ? userProfileImageMap.get(receiver.id!) : 'assets/no-profile-image.jpg'"
                *ngIf="receiver || group">
            <div class="ms-3">
                <span class="h4 text-light">
                    {{ receiver ? (receiver.name ? receiver.name : receiver.username) : group!.groupName }}
                </span>
                <br>
                <span class="text-light">
                    {{ receiver ? 'Online / Last Seen' : group!.membersId.length + ' Members' }}
                </span>
            </div>
        </div>
        <!-- CHAT HEADER ENDS HERE -->
        <!-- CHAT BODY -->
        <div #chatBody id="chat-body" class="chat-scroll container">
            <!-- IF NO PREVIOUS CHAT -->
            <ng-container *ngIf="messages.length === 0">
                <div id="no-message">
                    <div class="h3 p-3 rounded-5">Start a new Conversation</div>
                </div>
            </ng-container>
            <!-- IF PREVIOUS CHAT EXISTS -->
            <ng-container *ngIf="messages.length > 0">
                <!-- LOOP -->
                <div class="message px-3 row" *ngFor="let message of messages">
                    <div class="col-12 col-lg-6">
                        <div class="flex-start" *ngIf="isMessageComming(message)">
                            <div class="message-right py-3 px-4">
                                <span *ngIf="isOnlyTextMsg(message.messageFileType)">
                                    {{ message.content}}
                                </span>
                                <audio controls *ngIf="message.messageFileType === MessageFileType.AUDIO">
                                    <source [src]="message.content" type="audio/wav">
                                </audio>
                            </div>
                        </div>
                        <p class="message-time" *ngIf="isMessageComming(message)">
                            {{ message.timestamp | date:'hh:mm aa'}}
                        </p>
                    </div>

                    <div class="col-12 col-lg-6 flex-end">
                        <div *ngIf="isMessageGoing(message)">
                            <div class="message-left py-3 px-4">
                                <span *ngIf="isOnlyTextMsg(message.messageFileType)">
                                    {{ message.content}}
                                </span>
                                <audio controls *ngIf="message.messageFileType === MessageFileType.AUDIO">
                                    <source [src]="message.content" type="audio/wav">
                                </audio>
                            </div>
                            <p class="flex-end message-time">
                                {{ message.timestamp | date:'hh:mm aa'}}
                            </p>
                        </div>
                    </div>
                </div>
                <!-- LOOP ENDS -->
            </ng-container>
        </div>
        <!-- CHAT BODY ENDS HERE -->
        <!-- ACTION BAR -->
        <div id="chat-input-outer">
            <div id="chat-input" class="rounded-5">
                <input type="text" 
                       *ngIf="!recording && !isAudioReadyToSent" 
                       class="rounded-5" 
                       id="message-input"
                       name="message" 
                       placeholder="Type here..." 
                       [(ngModel)]="newMessage">

                <div *ngIf="recording" id="recording" class="ps-5">
                    <h2>Recording...</h2>
                </div>

                <div id="audio-div">
                    <audio controls *ngIf="url">
                        <source [src]="sanitize(url)" type="audio/wav">
                    </audio>
                    <button *ngIf="url" class="btn btn-light rounded-5" (click)="clearRecording()">
                        <mat-icon class="m-1" fontIcon="close"></mat-icon>
                    </button>
                </div>

                <div class="d-flex flex-row">
                    <input type="file" (change)="onFileSelected($event)" accept="image/png, image/jpeg" hidden>
                    <button class="btn btn-light rounded-5" (click)="startStop()">
                        <mat-icon *ngIf="!recording" fontIcon="mic"></mat-icon>
                        <mat-icon *ngIf="recording" fontIcon="stop_circle" class="scale-up"></mat-icon>
                    </button>
                    <button class="btn btn-light rounded-5 px-4" (click)="sendMessage()">
                        <mat-icon fontIcon="send"></mat-icon>
                    </button>
                </div>
            </div>
        </div>
        <!-- ACTION BAR ENDS HERE -->
    </div>
    <!-- CHAT SECTION ENDS HERE -->
</article>