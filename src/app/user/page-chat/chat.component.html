<ng-template #NewGroup>
    <div>
        <h2 mat-dialog-title class="m-0">New Group</h2>
    </div>
    <mat-dialog-content class="py-0">
        <div style="width: 767px;">
            <input type="text" name="group-name" id="group-name-input" placeholder="Name of Group"
                class="form-control mb-2" [(ngModel)]="groupName">
            <h2>Group Members</h2>
            <div id="peoples-section-body">
                <div *ngFor="let userId of inGroupUsers.keys()" class="inGroupUsers">
                    <div (click)="addToGroup(userId)" class="user-tile">
                        <img [src]="userProfileImageMap.get(userId)" alt="User Profile">
                        <div class="ms-3">
                            <p> {{ '@'+inGroupUsers.get(userId)!.username }} </p>
                            <p> {{ inGroupUsers.get(userId)!.name }} </p>
                        </div>
                    </div>
                    <mat-icon fontIcon="close" *ngIf="userId !== currentUser.id"
                        (click)="removeFromGroup(userId)"></mat-icon>
                </div>
            </div>
            <h2>Add Members From</h2>
            <div id="peoples-section-body">
                <div *ngFor="let userId of notInGroupUsers.keys()">
                    <div (click)="addToGroup(userId)" class="user-tile">
                        <img [src]="userProfileImageMap.get(userId)" alt="User Profile">
                        <div class="ms-3">
                            <p> {{ '@'+notInGroupUsers.get(userId)!.username }} </p>
                            <p> {{ notInGroupUsers.get(userId)!.name }} </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </mat-dialog-content>
    <mat-dialog-actions>
        <div class="flex-center">
            <button (click)="createNewGroup()" type="button" class="btn btn-success form-control m-1">Create</button>
            <button (click)="closeNewGroup()" type="button" class="btn btn-warning form-control m-1">Cancel</button>
        </div>
    </mat-dialog-actions>
</ng-template>

<ng-template #NewChat>
    <div>
        <h2 mat-dialog-title class="m-0">New Chat</h2>
    </div>
    <mat-dialog-content class="py-0">
        <div style="width: 500px;">
            <div id="peoples-section-body">
                <div *ngFor="let user of allUsers">
                    <div (click)="chatWithUser(user); closeNewChat();" class="user-tile">
                        <img [src]="userProfileImageMap.get(user.id!)" alt="User Profile">
                        <div class="ms-3">
                            <p> {{ '@'+user.username }}</p>
                            <Span>{{ user.name? user.name : 'User' }}</Span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </mat-dialog-content>
    <mat-dialog-actions>
        <button (click)="closeNewChat()" type="button" class="btn btn-dark form-control m-1">Close</button>
    </mat-dialog-actions>
</ng-template>

<article>
    <div id="side-nav"> 
        <side-nav-bar></side-nav-bar>
    </div>
<!-- PEOPLE LISTING SECTION STARTS HERE -->
    <div id="peoples-section">
        <!-- TOP SECTION -->
        <div id="peoples-section-header">
            <div class="flex-between-center mb-2">
                <p> Chats </p>
                <img  [src]="userProfileImageMap.get(currentUser.id!)" id="current-user" alt="User Profile">
            </div>
            <input type="text" 
                    class="form-control rounded-5" 
                    id="search" 
                    name="search" 
                    placeholder="Search"
                    [(ngModel)]="searchText">
            <div id="peoples-section-footer" class="pt-3">
                <div (click)="showGroups = false" [class]="{'active': !showGroups}">
                    Personal
                </div>
                <div (click)="showGroups = true" [class]="{'active': showGroups}">
                    Groups
                </div>
            </div>
        </div>
        <!-- TOP SECTION ENDS -->
        <!-- LISTING SECTION -->
        <div id="peoples-section-body" class="peoples-scroll" *ngIf="showGroups">
            <div *ngFor="let group of groups">
                <div (click)="chatInGroup(group)" class="user-tile">
                    <img src="assets/no-profile-image.jpg" alt="User Profile">
                    <div class="ms-3">
                        <p> {{ group.groupName }} </p>
                        <Span>{{ group.membersId.length +' Members'}}</Span>
                    </div>
                </div>
            </div>
        </div>
        <div id="peoples-section-body" class="peoples-scroll" *ngIf="!showGroups">
            <div *ngFor="let user of friendsList">
                <div (click)="chatWithUser(user)" class="user-tile">
                    <img [src]="userProfileImageMap.get(user.id!)" alt="User Profile">
                    <div class="ms-3">
                        <p> {{ user.username }} </p>
                        <Span>{{ (currentUser.id === user.id)? 'Me': 'Online / Last Seen'}}</Span>
                    </div>
                </div>
            </div>
        </div>
        <!-- LISTING SECTION ENDS -->
         <!-- FOOTER -->
        <div id="peoples-section-footer">
            <div (click)="openNewChat()">New Chat</div>
            <div (click)="open()">New Group</div>
        </div>
        <!-- FOOTER -->
    </div>
<!-- PEOPLE LISTING SECTION ENDS HERE -->
<!-- CHAT SECTION -->
    <div id="chat-section" *ngIf="(receiver || group)">
        <!-- CHAT HEADER -->
        <div id="chat-header">
            <img class="user-profile-picture" 
                [src]="receiver ? userProfileImageMap.get(receiver.id!) : 'assets/no-profile-image.jpg'"
                *ngIf="receiver || group">
            <div class="ms-3">
                <span class="h4 text-light">
                    {{ receiver ? (receiver.name ? receiver.name : receiver.username) : group!.groupName }}
                </span>
                <br>
                <span class="text-light">
                    {{ receiver ? 'Online / Last Seen' : group!.membersId.length + ' Members' }}
                </span>
            </div>
        </div>
        <!-- CHAT HEADER ENDS HERE -->
        <!-- CHAT BODY -->
        <div #chatBody id="chat-body" class="chat-scroll container p-0">
            <!-- IF NO PREVIOUS CHAT -->
            <ng-container *ngIf="messages.length === 0">
                <div id="no-message">
                    <div class="h3 p-3 rounded-5">Start a new Conversation</div>
                </div>
            </ng-container>
            <!-- IF PREVIOUS CHAT EXISTS -->
            <ng-container *ngIf="messages.length > 0">
                <!-- LOOP -->
                <div class="message px-3 row" *ngFor="let message of messages">
                    <div class="col-12 col-md-6">
                        <div class="d-flex flex-row align-items-end"  *ngIf="isMessageComming(message)">
                            <div class="image-div-chat">
                                <img  [src]="userProfileImageMap.get(Number(message.senderId))" id="current-user" alt="User Profile">
                            </div>
                            <div>
                                <div class="flex-start">
                                    <div class="message-right p-1" 
                                        [class]="{'py-3': isOnlyTextMsg(message.messageFileType), 'px-4': isOnlyTextMsg(message.messageFileType)}">
                                        <span *ngIf="isOnlyTextMsg(message.messageFileType)">
                                            {{ message.content}}
                                        </span>
                                        <audio controls *ngIf="message.messageFileType === MessageFileType.AUDIO">
                                            <source [src]="message.content" type="audio/wav">
                                        </audio>
                                        <img [src]="message.content" 
                                             *ngIf="message.messageFileType === MessageFileType.IMAGE"
                                             class="image-basics-chat rounded-4" 
                                             alt="Image preview">
                                        <video [src]="message.content" 
                                               controls  
                                               *ngIf="message.messageFileType === MessageFileType.VIDEO"
                                               class="image-basics-chat border border-dark rounded">
                                        </video>
                                    </div>
                                </div>
                                <p class="message-time">
                                    {{ message.timestamp | date:'hh:mm aa'}}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-lg-6 flex-end pe-0">
                        <div *ngIf="isMessageGoing(message)">
                            <div class="message-left p-1" 
                                [class]="{'py-3': isOnlyTextMsg(message.messageFileType), 'px-4': isOnlyTextMsg(message.messageFileType)}">
                                <span *ngIf="isOnlyTextMsg(message.messageFileType)">
                                    {{ message.content }}
                                </span>
                                <audio controls *ngIf="message.messageFileType === MessageFileType.AUDIO">
                                    <source [src]="message.content" type="audio/wav">
                                </audio>
                                <img [src]="message.content" 
                                     *ngIf="message.messageFileType === MessageFileType.IMAGE"
                                     class="image-basics-chat rounded-4" 
                                     alt="Image preview">
                                <video [src]="message.content" 
                                       controls  
                                       *ngIf="message.messageFileType === MessageFileType.VIDEO"
                                       class="image-basics-chat border border-dark rounded"></video>
                            </div>
                            <p class="flex-end message-time">
                                {{ message.timestamp | date:'hh:mm aa'}}
                            </p>
                        </div>
                    </div>
                </div>
                <!-- LOOP ENDS -->
            </ng-container>
        </div>
        <!-- CHAT BODY ENDS HERE -->
        <!-- ACTION BAR -->
        <div *ngIf="isListVisible" class="list-container">
            <ul>
                <li (click)="triggerImageInput()"> 
                    <mat-icon style="color: white" class="me-1" fontIcon="crop_original"></mat-icon> Images
                </li>
                <li (click)="triggerVideoInput()"> 
                    <mat-icon style="color: white" class="me-1" fontIcon="smart_display"></mat-icon> Videos
                </li>
            </ul>
        </div>
        <div id="chat-input-outer">
            <div id="chat-input" class="rounded-5">
                <input type="text" 
                       *ngIf="!recording && !isAudioReadyToSent" 
                       class="rounded-5" 
                       id="message-input"
                       name="message" 
                       placeholder="Type here..." 
                       (keydown.enter)="sendMessage()"
                       [(ngModel)]="newMessage">

                <div *ngIf="recording" id="recording" class="ps-5">
                    <h2>Recording...</h2>
                </div>

                <div id="audio-div">
                    <audio controls *ngIf="url">
                        <source [src]="sanitize(url)" type="audio/wav">
                    </audio>
                    <button *ngIf="url" class="btn btn-light rounded-5" (click)="clearRecording()">
                        <mat-icon class="m-1" fontIcon="close"></mat-icon>
                    </button>
                </div>

                <div class="d-flex flex-row">
                    <button class="btn btn-light rounded-5" *ngIf="!recording"  (click)="toggleListVisibility()">
                        <mat-icon fontIcon="add"></mat-icon>
                    </button>
                    <button class="btn btn-light rounded-5" (click)="toggleStartStopRecording()">
                        <mat-icon *ngIf="!recording" fontIcon="mic"></mat-icon>
                        <mat-icon *ngIf="recording" fontIcon="stop_circle" class="scale-up"></mat-icon>
                    </button>
                    <button class="btn btn-light rounded-5 px-4" (click)="sendMessage()" [disabled]="sendingSpinner">
                        <mat-icon *ngIf="!sendingSpinner" fontIcon="send"></mat-icon>
                        <div class="loader" style="width: 30px;" *ngIf="sendingSpinner"></div>
                    </button>
                </div>
            </div>
        </div>
        <!-- ACTION BAR ENDS HERE -->
    </div>
    <!-- CHAT SECTION ENDS HERE -->
</article>

<input type="file" (change)="onFileSelected($event, MessageFileType.IMAGE)" accept="image/png, image/jpeg" hidden #imageInput>
<input type="file" (change)="onFileSelected($event, MessageFileType.VIDEO)" accept="video/mp4, video/webm" hidden #videoInput>


<ng-template #UploadMedia>
    <div>
        <h2 mat-dialog-title class="m-0">{{ selectedFileType | titlecase }}</h2>
    </div>
    <mat-dialog-content class="py-0">
        <div style="width: 500px;">
            <div *ngIf="selectedFileType === MessageFileType.IMAGE">
                <img [src]="previewUrl" class="image-basics" alt="Image preview rounded">
            </div>
            <div *ngIf="selectedFileType === MessageFileType.VIDEO">
                <video [src]="previewUrl" controls  class="image-basics border border-dark rounded"></video>
            </div>
        </div>
    </mat-dialog-content>
    <mat-dialog-actions>
        <div class="flex-center">
            <button (click)="closeDialog()" type="button" class="btn btn-dark form-control m-1">Close</button>
            <button (click)="uploadMedia()" type="button" class="btn btn-dark form-control m-1">Send</button>
        </div>
    </mat-dialog-actions>
</ng-template>